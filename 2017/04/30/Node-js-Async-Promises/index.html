<!DOCTYPE html>
<html lang=En>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="IntroductionES6 promises are harder to learn then traditional callback interfaces.But after you get used to them makes your code much more readable and easier to develop. BasicsA promise is just an ob">
<meta name="keywords" content="Node.js,Promise">
<meta property="og:type" content="article">
<meta property="og:title" content="Node.js Async: How to Use ES6 Promises">
<meta property="og:url" content="http://peterforgacs.github.io/2017/04/30/Node-js-Async-Promises/index.html">
<meta property="og:site_name" content="notes.txt">
<meta property="og:description" content="IntroductionES6 promises are harder to learn then traditional callback interfaces.But after you get used to them makes your code much more readable and easier to develop. BasicsA promise is just an ob">
<meta property="og:locale" content="English">
<meta property="og:updated_time" content="2017-05-28T14:51:25.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Node.js Async: How to Use ES6 Promises">
<meta name="twitter:description" content="IntroductionES6 promises are harder to learn then traditional callback interfaces.But after you get used to them makes your code much more readable and easier to develop. BasicsA promise is just an ob">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Node.js Async: How to Use ES6 Promises</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/peterforgacs">Projects</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a id="previous-post" class="icon" href="/2017/05/25/Best-vscode-plugins/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li>
        
        
        <li><a id="next-post" class="icon" href="/2017/04/28/Node-js-Patterns-Sequential-Iteration-Pattern/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://peterforgacs.github.io/2017/04/30/Node-js-Async-Promises/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://peterforgacs.github.io/2017/04/30/Node-js-Async-Promises/&text=Node.js Async: How to Use ES6 Promises"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://peterforgacs.github.io/2017/04/30/Node-js-Async-Promises/&title=Node.js Async: How to Use ES6 Promises"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://peterforgacs.github.io/2017/04/30/Node-js-Async-Promises/&is_video=false&description=Node.js Async: How to Use ES6 Promises"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Node.js Async: How to Use ES6 Promises&body=Check out this article: http://peterforgacs.github.io/2017/04/30/Node-js-Async-Promises/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://peterforgacs.github.io/2017/04/30/Node-js-Async-Promises/&title=Node.js Async: How to Use ES6 Promises"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://peterforgacs.github.io/2017/04/30/Node-js-Async-Promises/&title=Node.js Async: How to Use ES6 Promises"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://peterforgacs.github.io/2017/04/30/Node-js-Async-Promises/&title=Node.js Async: How to Use ES6 Promises"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://peterforgacs.github.io/2017/04/30/Node-js-Async-Promises/&title=Node.js Async: How to Use ES6 Promises"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://peterforgacs.github.io/2017/04/30/Node-js-Async-Promises/&name=Node.js Async: How to Use ES6 Promises&description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Basics"><span class="toc-number">1.1.</span> <span class="toc-text">Basics</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Then"><span class="toc-number">1.2.</span> <span class="toc-text">Then</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Catch-in-chains"><span class="toc-number">1.3.</span> <span class="toc-text">Catch in chains</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Branching-chains"><span class="toc-number">1.4.</span> <span class="toc-text">Branching chains</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dealing-with-callback-interface"><span class="toc-number">1.5.</span> <span class="toc-text">Dealing with callback interface</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Placing-directly-inside-a-then"><span class="toc-number">1.5.1.</span> <span class="toc-text">Placing directly inside a then</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Wrapping-in-a-promise"><span class="toc-number">1.5.2.</span> <span class="toc-text">Wrapping in a promise</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Promisify"><span class="toc-number">1.5.3.</span> <span class="toc-text">Promisify</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Promise-all"><span class="toc-number">1.6.</span> <span class="toc-text">Promise.all</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Promise-race"><span class="toc-number">1.7.</span> <span class="toc-text">Promise.race</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Iterating-over-arrays-with-promises"><span class="toc-number">1.8.</span> <span class="toc-text">Iterating over arrays with promises</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Node.js Async: How to Use ES6 Promises
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Peter Forgacs</span>
      </span>
      
    <div class="postdate">
        <time datetime="2017-04-30T14:27:03.000Z" itemprop="datePublished">2017-04-30</time>
        <span class="readTime"></span>
    </div>


      
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Node-js/">Node.js</a>, <a class="tag-link" href="/tags/Promise/">Promise</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>ES6 promises are harder to learn then traditional callback interfaces.<br>But after you get used to them makes your code much more readable and easier to develop.</p>
<h2 id="Basics"><a href="#Basics" class="headerlink" title="Basics"></a>Basics</h2><p>A promise is just an object.<br>A promise can be either pending or settled.<br>A settled promise can be fulfilled or rejected.<br>We can ‘listen’ for a certain promise to be settled with the .then() and .catch().</p>
<p>With a single then() you can receive two callback functions.<br>One for onfulfilled success and one for onfailure.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunction</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">			resolve(<span class="string">'async resolve'</span>);</span><br><span class="line">            reject(<span class="string">'async reject'</span>);</span><br><span class="line">        &#125;, <span class="number">1000</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">myFunction()</span><br><span class="line">.then( <span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(val);</span><br><span class="line">&#125;, err =&gt; &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(err);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="Then"><a href="#Then" class="headerlink" title="Then"></a>Then</h2><p>A then can only placed after promise.<br>Thens can be chained.</p>
<p>The return value of the previous then will be the argument for the next then in the chain.</p>
<p>If that return value is a promise the next then in the chain only gets called if that promise is fulfilled.</p>
<p>If the then returns nothing the next then argument will be undefined.</p>
<p>Things you can return from a then:</p>
<ul>
<li>You can simply return a value from a then.</li>
<li>You can return a promise.</li>
<li>You can return a function that returns a promise.</li>
<li>If you use return synchronously it does not get called again.</li>
</ul>
<p>Its important to note that in a promise chain if you have an async function call which returns a promise you must return it inside the then() otherwise the chain goes on without waiting for the promise.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myAsync</span>(<span class="params">val</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        resolve(val+<span class="number">1</span>)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.resolve(<span class="number">1</span>)															<span class="comment">// 1</span></span><br><span class="line">.then( <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span> ( <span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">		resolve(value+<span class="number">1</span>);													<span class="comment">// 2</span></span><br><span class="line">	&#125;);</span><br><span class="line">&#125;)</span><br><span class="line">.then( <span class="function"><span class="params">value</span> =&gt;</span> &#123;													</span><br><span class="line">	<span class="keyword">return</span> myAsync(value);													<span class="comment">// 3</span></span><br><span class="line">&#125;)</span><br><span class="line">.then( <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> (value+<span class="number">1</span>);														<span class="comment">// 4</span></span><br><span class="line">&#125;)</span><br><span class="line">.then( <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(value);</span><br><span class="line">&#125;)</span><br><span class="line">.catch( <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(error);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="Catch-in-chains"><a href="#Catch-in-chains" class="headerlink" title="Catch in chains"></a>Catch in chains</h2><p>You can throw synch error.<br>You can reject a promise.<br>You can directly use Promise.resolve() and Promise.reject().<br>You can listen to error from a previous then with a second argument from then.<br>You can listen to a whole chain with catch.<br>You can add a then after a catch.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myAsyncReject</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        reject(<span class="string">'Rejected from async'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.resolve(<span class="number">1</span>)</span><br><span class="line">.then( <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">   <span class="keyword">throw</span> <span class="string">'sync throw'</span>;                      <span class="comment">// Synch throw</span></span><br><span class="line">&#125;)</span><br><span class="line">.then( <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">   <span class="comment">// Not getting called</span></span><br><span class="line">&#125;, (err) =&gt; &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(err);</span><br><span class="line">	<span class="keyword">return</span> <span class="string">'Recovering from sync throw'</span>;</span><br><span class="line">&#125;)</span><br><span class="line">.then( <span class="function"><span class="params">recovery</span> =&gt;</span> &#123;</span><br><span class="line">   <span class="built_in">console</span>.log(recovery);</span><br><span class="line">&#125;)</span><br><span class="line">.then( <span class="function"><span class="params">()</span> =&gt;</span> &#123;							    <span class="comment">// Since nothing is returned in the previous then</span></span><br><span class="line">   	<span class="keyword">return</span> myAsyncReject();					<span class="comment">// Async Reject</span></span><br><span class="line">&#125;)</span><br><span class="line">.then( <span class="function"><span class="params">val</span> =&gt;</span> &#123;                             <span class="comment">// Should not be called</span></span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">'Should not be called'</span>);</span><br><span class="line">&#125;)</span><br><span class="line">.catch( <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">   <span class="built_in">console</span>.log(error);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="Branching-chains"><a href="#Branching-chains" class="headerlink" title="Branching chains"></a>Branching chains</h2><p>You can place a then inside a then or event in a catch as long it has an async call before it.</p>
<p>A child branch can have its own thens and catches.<br>Returning from the last then in a branch returns the parents branch next then.</p>
<p>Throwing an error in a child branch triggers the child branch catch.<br>If it does not have a catch it lands in the parents nearest catch and so on.</p>
<p>If you return from a child 2 levels deep and there are no immidiate parent then it will return the value for the nearest parent then aka. first parent then.</p>
<p>Here we have multiple .then branches.<br>At the end of the first branch we throw an error to the parent branch catch.<br>The second .then branch returns a value to the parent branch.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myAsync</span>(<span class="params">val</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        resolve(val+<span class="number">1</span>)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myAsync2</span>(<span class="params">callback</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        fs.readFile(<span class="string">'./test.txt'</span>, <span class="string">'utf-8'</span>, (err, data) =&gt; &#123;</span><br><span class="line">            callback(data, val =&gt;&#123;</span><br><span class="line">                resolve(val);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myCallback</span>(<span class="params">data, cb</span>)</span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        cb(data + <span class="string">"_changed"</span>);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.resolve(<span class="number">1</span>)									<span class="comment">// 1</span></span><br><span class="line">.then( <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span> ( <span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">		resolve(value+<span class="number">1</span>);							<span class="comment">// 2</span></span><br><span class="line">	&#125;);</span><br><span class="line">&#125;)</span><br><span class="line">.then( <span class="function"><span class="params">value</span> =&gt;</span> &#123;													</span><br><span class="line">	<span class="keyword">return</span> myAsync(value);							<span class="comment">// 3</span></span><br><span class="line">&#125;)</span><br><span class="line">.then( <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> (value+<span class="number">1</span>);								<span class="comment">// 4</span></span><br><span class="line">&#125;)</span><br><span class="line">.then( <span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(value);</span><br><span class="line">&#125;)</span><br><span class="line">.then( <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> myAsync(<span class="number">0</span>)                               <span class="comment">// 1</span></span><br><span class="line">    .then(<span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (val+<span class="number">1</span>);                             <span class="comment">// 2</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function"><span class="params">val</span> =&gt;</span> &#123;                                  <span class="comment">// 3</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>( <span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            resolve(val+<span class="number">1</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">        .then(<span class="function"><span class="params">val</span> =&gt;</span> &#123;                               <span class="comment">// 4</span></span><br><span class="line">            <span class="keyword">return</span> val+<span class="number">1</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(val);</span><br><span class="line">        <span class="keyword">throw</span>(<span class="string">'inside error'</span>);                      <span class="comment">// Inner catch</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err);</span><br><span class="line">        <span class="keyword">throw</span>(<span class="string">'outside error'</span>);                     <span class="comment">// Outside catch</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br><span class="line">.catch( <span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(error);</span><br><span class="line">    <span class="keyword">return</span> myAsync2(myCallback)</span><br><span class="line">        .then(<span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(val);</span><br><span class="line">            <span class="keyword">return</span>(<span class="string">'hi'</span>);        </span><br><span class="line">        &#125;)</span><br><span class="line">&#125;)</span><br><span class="line">.then( <span class="function"><span class="params">greeting</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(greeting);                          <span class="comment">// hi</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="Dealing-with-callback-interface"><a href="#Dealing-with-callback-interface" class="headerlink" title="Dealing with callback interface"></a>Dealing with callback interface</h2><p>All of the official node.js modules and most of the npm packages use the callback interface.</p>
<p>This can make it tricky to use them with promises.</p>
<h3 id="Placing-directly-inside-a-then"><a href="#Placing-directly-inside-a-then" class="headerlink" title="Placing directly inside a then"></a>Placing directly inside a then</h3><p>This is ideal if you need a callback based interface at the end of the chain.</p>
<p>The problem with this is that if you place another then after the callback it will fire before the actual async functions has been finished.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.resolve()</span><br><span class="line">.then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">	setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'hi'</span>);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Wrapping-in-a-promise"><a href="#Wrapping-in-a-promise" class="headerlink" title="Wrapping in a promise"></a>Wrapping in a promise</h3><p>By wrapping in a promise a callback function can be used in a promise chain easily.<br>I wrap most of my functions in a similar way.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.resolve()</span><br><span class="line">    .then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                resolve(<span class="string">'hi'</span>);</span><br><span class="line">            &#125;, <span class="number">1000</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function"><span class="params">greeting</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(greeting);</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>
<h3 id="Promisify"><a href="#Promisify" class="headerlink" title="Promisify"></a>Promisify</h3><p>You can promisfy an existing callback based module with <a href="https://www.npmjs.com/package/promisify-node" target="_blank" rel="noopener">Promisify</a>. This way you can promisify whole modules without having to modify it.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> promisify = <span class="built_in">require</span>(<span class="string">"promisify-node"</span>);</span><br><span class="line"><span class="keyword">var</span> fs = promisify(<span class="string">"fs"</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// This function has been identified as an asynchronous function so it has </span></span><br><span class="line"><span class="comment">// been automatically wrapped. </span></span><br><span class="line">fs.readFile(<span class="string">"/etc/passwd"</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">contents</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(contents);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="Promise-all"><a href="#Promise-all" class="headerlink" title="Promise.all"></a>Promise.all</h2><p>Good for waiting for all the promises to fulfill at once.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> p1 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123; </span><br><span class="line">  setTimeout(resolve, <span class="number">1000</span>, <span class="string">'one'</span>); </span><br><span class="line">&#125;); </span><br><span class="line"><span class="keyword">var</span> p2 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123; </span><br><span class="line">  setTimeout(resolve, <span class="number">2000</span>, <span class="string">'two'</span>); </span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> p3 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  setTimeout(resolve, <span class="number">3000</span>, <span class="string">'three'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> p4 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  setTimeout(resolve, <span class="number">4000</span>, <span class="string">'four'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.all([p1, p2, p3, p4]).then(<span class="function"><span class="params">values</span> =&gt;</span> &#123; </span><br><span class="line">  <span class="built_in">console</span>.log(values);</span><br><span class="line">&#125;, reason =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(reason)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="Promise-race"><a href="#Promise-race" class="headerlink" title="Promise.race"></a>Promise.race</h2><p>Waiting for multiple promises but only get the one which resolves faster.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> p1 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123; </span><br><span class="line">    setTimeout(resolve, <span class="number">500</span>, <span class="string">'one'</span>); </span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> p2 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123; </span><br><span class="line">    setTimeout(resolve, <span class="number">100</span>, <span class="string">'two'</span>); </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.race([p1, p2]).then(<span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(value); <span class="comment">// "two"</span></span><br><span class="line">  <span class="comment">// Both resolve, but p2 is faster</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="Iterating-over-arrays-with-promises"><a href="#Iterating-over-arrays-with-promises" class="headerlink" title="Iterating over arrays with promises"></a>Iterating over arrays with promises</h2><p>This can be tricky. You can use custom Promise libraries to make it easier but you can check out my tutorial on <a href="http://peterforgacs.github.io/2017/04/28/Node-js-Patterns-Sequential-Iteration-Pattern/">Sequential iteration pattern</a> for an easy solution that works most of the time.</p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        </div>
    </div>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/peterforgacs">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Basics"><span class="toc-number">1.1.</span> <span class="toc-text">Basics</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Then"><span class="toc-number">1.2.</span> <span class="toc-text">Then</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Catch-in-chains"><span class="toc-number">1.3.</span> <span class="toc-text">Catch in chains</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Branching-chains"><span class="toc-number">1.4.</span> <span class="toc-text">Branching chains</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dealing-with-callback-interface"><span class="toc-number">1.5.</span> <span class="toc-text">Dealing with callback interface</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Placing-directly-inside-a-then"><span class="toc-number">1.5.1.</span> <span class="toc-text">Placing directly inside a then</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Wrapping-in-a-promise"><span class="toc-number">1.5.2.</span> <span class="toc-text">Wrapping in a promise</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Promisify"><span class="toc-number">1.5.3.</span> <span class="toc-text">Promisify</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Promise-all"><span class="toc-number">1.6.</span> <span class="toc-text">Promise.all</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Promise-race"><span class="toc-number">1.7.</span> <span class="toc-text">Promise.race</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Iterating-over-arrays-with-promises"><span class="toc-number">1.8.</span> <span class="toc-text">Iterating over arrays with promises</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://peterforgacs.github.io/2017/04/30/Node-js-Async-Promises/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://peterforgacs.github.io/2017/04/30/Node-js-Async-Promises/&text=Node.js Async: How to Use ES6 Promises"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://peterforgacs.github.io/2017/04/30/Node-js-Async-Promises/&title=Node.js Async: How to Use ES6 Promises"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://peterforgacs.github.io/2017/04/30/Node-js-Async-Promises/&is_video=false&description=Node.js Async: How to Use ES6 Promises"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Node.js Async: How to Use ES6 Promises&body=Check out this article: http://peterforgacs.github.io/2017/04/30/Node-js-Async-Promises/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://peterforgacs.github.io/2017/04/30/Node-js-Async-Promises/&title=Node.js Async: How to Use ES6 Promises"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://peterforgacs.github.io/2017/04/30/Node-js-Async-Promises/&title=Node.js Async: How to Use ES6 Promises"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://peterforgacs.github.io/2017/04/30/Node-js-Async-Promises/&title=Node.js Async: How to Use ES6 Promises"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://peterforgacs.github.io/2017/04/30/Node-js-Async-Promises/&title=Node.js Async: How to Use ES6 Promises"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://peterforgacs.github.io/2017/04/30/Node-js-Async-Promises/&name=Node.js Async: How to Use ES6 Promises&description="><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick='$("#toc-footer").toggle();return false;'><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick='$("#share-footer").toggle();return false;'><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick='$("#nav-footer").toggle();return false;'><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2019 Peter Forgacs
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/peterforgacs">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">


<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-97407927-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'peterforgacs-github-io';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


